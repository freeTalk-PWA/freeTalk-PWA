<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>freeTalk.PS</title>

  <link href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" rel="stylesheet" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="shortcut icon" type="image/png" href="images/freeTalk.001.64px.png" />
  <link rel="apple-touch-icon" href="assets/" />
  <link rel="stylesheet" href="style.css" />
</head>

<!-- <div class="container scanner">
  <div class="vcenter d-flex justify-content-center">
    <div class="card">

    </div>
  </div>
</div> -->

<div class="container chat-ui">
  <div class="vcenter d-flex justify-content-center">
    <div class="card">
      <div class="d-flex flex-row justify-content-between p-3 adiv text-white"> <i class="fas fa-chevron-left"></i>
        <span id="pb-3" style="display: none;">Channel: <a id="channelName"></a></span> <i class="fa fa-cog"></i>
      </div>
      <div class="entryInput" id="entryInput">
        <img src="images/Logo.png" alt="" class="logo">
        <h3>Entry Form</h3>
        <form onsubmit="return entry();" id="entryForm">
          <input type="text" id="u" name="u" placeholder="Metaname"><br>
          <input type="password" id="p" name="p" placeholder="Password"><br>
          <input type="submit" value="Submit">
          <h4 id="errMsg"></h4>
        </form>
      </div>
      <div class="scroller hidden" id="scroller">
      </div>
      <!--  -->
      <div class="chatInput form-group px-3 hidden" id="chatInput">
        <button id="sendBtn" onclick="send()"><i class="material-icons">&#xe163;</i></button>
        <textarea class="form-control" id="msg" rows="5" placeholder="Type your message"></textarea>
      </div>
    </div>
  </div>
</div>

<script>
  const queryString = window.location.search;
  const urlParams = new window.URLSearchParams(queryString);

  var form = document.getElementById("entryForm");

  form.addEventListener('submit', handleForm);

  if (!urlParams.get('l')) {
    window.location.href = './404.html';
  }

  const Subdomain = urlParams.get('l');
  const AdminFlag = urlParams.get('A');

  sessionStorage.setItem('Subdomain', Subdomain);

  if (typeof AdminFlag != 'string') {
    document.getElementById("p").style.opacity = "0.0";
  }

  function handleForm(event) { event.preventDefault(); }

  function entry() {
    // Extracting form input

    let u = document.getElementById("u").value;
    let p = document.getElementById("p").value;

    if (u == '') {
      document.getElementById("errMsg").innerHTML = "Please enter a valid metaname";
      document.getElementById("p").value = "";

      return null;
    } else if (typeof AdminFlag == 'string' && p == '') {
      document.getElementById("errMsg").innerHTML = "Please type in the password";

      return null;
    }

    // Connecting to the server's public domain (Subdomain + '.ngrok.io')

    if (!sessionStorage.getItem('clientKey')) {
      const cnxnRespond = httpGet('https://' + Subdomain + '.ngrok.io/' + (typeof AdminFlag == 'string' ? 'A' : ''));

      sessionStorage.setItem('clientKey', cnxnRespond.clientKey);
    }

    if (sessionStorage.getItem('clientKey')) {
      if (typeof AdminFlag == 'string') {
        // performing an adminEntry (requires a metaName & a password)

        entryRespond = httpPost('https://' + Subdomain + '.ngrok.io/adminEntry', { "clientKey": sessionStorage.getItem('clientKey'), "metaName": u, "password": p });

        if (entryRespond.R == 1) {
          // post-entry actions

          document.getElementById("channelName").innerHTML = entryRespond.C;
          document.getElementById("pb-3").style.display = "block";

          document.getElementById("entryInput").classList.add('fade-out');
          document.getElementById("scroller").classList.remove('hidden');
          document.getElementById("chatInput").classList.remove('hidden');

          var intervalId = setInterval(updateMsgsQueue, 2500, Subdomain);
        } else {
          document.getElementById("errMsg").innerHTML = entryRespond.errMsg;

          if (sessionStorage.getItem('clientKey')) { sessionStorage.removeItem('clientKey'); }

          return null;
        }
      } else {
        // performing an entry (requires a metaName)

        entryRespond = httpPost('https://' + Subdomain + '.ngrok.io/entry', { "clientKey": sessionStorage.getItem('clientKey'), "metaName": u });

        if (entryRespond.R == 1) {
          // post-entry actions

          document.getElementById("channelName").innerHTML = entryRespond.C;
          document.getElementById("pb-3").style.display = "block";

          document.getElementById("entryInput").classList.add('fade-out');
          document.getElementById("scroller").classList.remove('hidden');
          document.getElementById("chatInput").classList.remove('hidden');

          var intervalId = setInterval(updateMsgsQueue, 2500, Subdomain);
        } else {
          document.getElementById("errMsg").innerHTML = entryRespond.errMsg;

          if (sessionStorage.getItem('clientKey')) { sessionStorage.removeItem('clientKey'); }

          return null;
        }
      }
    } else {
      console.log('server is down');
    }
    return 1;
  }

  function httpGet(Domain) {
    var xmlHttp = new XMLHttpRequest();

    xmlHttp.open("GET", Domain, false); // `false` makes the request synchronous
    xmlHttp.send(null);

    if (xmlHttp.status === 200) {
      return JSON.parse(xmlHttp.responseText);
    } else {
      return null;
    }
  }

  function httpPost(Domain, Data) {
    var xmlHttp = new XMLHttpRequest();

    xmlHttp.open("POST", Domain, false);
    xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

    let dataString = "";

    for (var i in Data) {
      if (dataString.length > 0) {
        dataString += '&' + i + '=' + Data[i];
      } else {
        dataString += i + '=' + Data[i];
      }
    }

    xmlHttp.send(dataString);

    if (xmlHttp.status === 200) {
      return JSON.parse(xmlHttp.responseText);
    } else {
      return null;
    }
  }

  function updateMsgsQueue(Subdomain) {
    msgsQuery = httpPost('https://' + Subdomain + '.ngrok.io/msgs', { "clientKey": sessionStorage.getItem('clientKey') });

    if (msgsQuery.R == 1) {
      let msgsQueue = '';

      for (let i = 0; i < msgsQuery.A.length; i++) {
        if (msgsQuery.A[i].clientKey == sessionStorage.getItem('clientKey')) {
          msgsQueue += `
            <div class="d-flex flex-row p-3"> <img
                src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-7.png" width="30" height="30">
              <div class="chat ml-2 p-3">${msgsQuery.A[i].msgContent}</div>
            </div>
          `;
        } else {
          msgsQueue += `
          <div class="d-flex flex-row p-3 others">
            <div class="bg-white mr-2 p-3">
              <span class="text-muted">${msgsQuery.A[i].msgContent}</span>
            </div>
            <img src="https://img.icons8.com/color/48/000000/circled-user-male-skin-type-7.png" width="30" height="30">
          </div>
          `;
        }
      }
      document.getElementById("scroller").innerHTML = msgsQueue;
    }
  }

  function send() {
    let msg = document.getElementById("msg").value;

    document.getElementById("msg").value = '';

    msgSend = httpPost('https://' + sessionStorage.getItem('Subdomain') + '.ngrok.io/send', { "clientKey": sessionStorage.getItem('clientKey'), "msgContent": msg });

    if (msgSend.R == 1) {
      updateMsgsQueue(sessionStorage.getItem('Subdomain'));
    }
  }
</script>

</html>